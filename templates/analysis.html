{% extends "base.html" %}

{% block title %}Data Analysis - HeartGuard AI{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-12">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-3"></i>
                    Data Analysis Dashboard
                </h1>
                <p class="page-description">
                    Comprehensive analysis of heart disease data and model performance metrics.
                </p>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading analysis data...</p>
            </div>

            <!-- Analysis Content -->
            <div id="analysisContent" style="display: none;">
                <!-- Dataset Overview -->
                <div class="row mb-5">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-database me-2"></i>Dataset Overview
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="row" id="datasetInfo">
                                    <!-- Dataset information will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feature Importance -->
                <div class="row mb-5">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>Feature Importance
                                </h4>
                            </div>
                            <div class="card-body">
                                <canvas id="featureImportanceChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Factors Analysis -->
                <div class="row mb-5">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Risk Factors Analysis
                                </h4>
                            </div>
                            <div class="card-body">
                                <canvas id="riskFactorsChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Performance -->
                <div class="row mb-5">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-tachometer-alt me-2"></i>Model Performance
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <canvas id="modelComparisonChart" width="400" height="300"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="modelMetrics">
                                            <!-- Model metrics will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Tips -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>Health Tips & Recommendations
                                </h4>
                            </div>
                            <div class="card-body">
                                <div id="healthTips">
                                    <!-- Health tips will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Load analysis data
        const analysisData = await loadAnalysisData();
        
        // Display dataset information
        displayDatasetInfo(analysisData.dataset_info);
        
        // Create charts
        createFeatureImportanceChart(analysisData.feature_importance);
        createRiskFactorsChart(analysisData.risk_factors);
        
        // Load health tips
        await loadHealthTips();
        
        // Hide loading spinner and show content
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('analysisContent').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading analysis:', error);
        document.getElementById('loadingSpinner').innerHTML = 
            '<div class="alert alert-danger">Error loading analysis data. Please try again later.</div>';
    }
});

async function loadAnalysisData() {
    const response = await fetch('/api/analysis');
    if (!response.ok) {
        throw new Error('Failed to load analysis data');
    }
    return await response.json();
}

function displayDatasetInfo(datasetInfo) {
    const datasetDiv = document.getElementById('datasetInfo');
    datasetDiv.innerHTML = `
        <div class="col-md-3">
            <div class="stat-card">
                <h3 class="stat-number">${datasetInfo.total_samples.toLocaleString()}</h3>
                <p class="stat-label">Total Samples</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3 class="stat-number">${datasetInfo.features}</h3>
                <p class="stat-label">Features</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3 class="stat-number">${datasetInfo.target_distribution.Yes || 0}</h3>
                <p class="stat-label">Heart Disease Cases</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3 class="stat-number">${datasetInfo.target_distribution.No || 0}</h3>
                <p class="stat-label">Healthy Cases</p>
            </div>
        </div>
    `;
}

function createFeatureImportanceChart(featureImportance) {
    const ctx = document.getElementById('featureImportanceChart').getContext('2d');
    
    const features = Object.keys(featureImportance);
    const values = Object.values(featureImportance);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: features,
            datasets: [{
                label: 'Importance',
                data: values,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Feature Importance in Heart Disease Prediction'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Importance Score'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Features'
                    }
                }
            }
        }
    });
}

function createRiskFactorsChart(riskFactors) {
    const ctx = document.getElementById('riskFactorsChart').getContext('2d');
    
    const factors = Object.keys(riskFactors);
    const yesRates = factors.map(factor => riskFactors[factor].Yes);
    const noRates = factors.map(factor => riskFactors[factor].No);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: factors,
            datasets: [
                {
                    label: 'With Factor',
                    data: yesRates,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Without Factor',
                    data: noRates,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Heart Disease Rate by Risk Factors'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    title: {
                        display: true,
                        text: 'Heart Disease Rate'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Risk Factors'
                    }
                }
            }
        }
    });
}

async function loadHealthTips() {
    try {
        const response = await fetch('/api/health-tips');
        const tips = await response.json();
        
        const tipsDiv = document.getElementById('healthTips');
        tipsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="fas fa-heart me-2"></i>General Health</h5>
                    <ul class="list-group list-group-flush">
                        ${tips.general.map(tip => `<li class="list-group-item">${tip}</li>`).join('')}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5><i class="fas fa-heartbeat me-2"></i>Heart Health</h5>
                    <ul class="list-group list-group-flush">
                        ${tips.heart_health.map(tip => `<li class="list-group-item">${tip}</li>`).join('')}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5><i class="fas fa-shield-alt me-2"></i>Prevention</h5>
                    <ul class="list-group list-group-flush">
                        ${tips.prevention.map(tip => `<li class="list-group-item">${tip}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading health tips:', error);
    }
}
</script>
{% endblock %}
