{% extends "base.html" %}

{% block title %}Heart Disease Prediction - HeartGuard AI{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="page-title">
                    <i class="fas fa-stethoscope me-3"></i>
                    Heart Disease Prediction
                </h1>
                <p class="page-description">
                    Fill in your health information below to get your personalized heart disease risk assessment.
                </p>
            </div>

            <!-- Prediction Form -->
            <div class="prediction-form">
                <form id="predictionForm">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="BMI" class="form-label">Body Mass Index (BMI)</label>
                                <input type="number" class="form-control" id="BMI" name="BMI" 
                                       min="10" max="100" step="0.1" required>
                                <div class="form-text">Enter your BMI (10-100)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="Sex" class="form-label">Sex</label>
                                <select class="form-select" id="Sex" name="Sex" required>
                                    <option value="">Select Sex</option>
                                    <option value="Female">Female</option>
                                    <option value="Male">Male</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="AgeCategory" class="form-label">Age Category</label>
                                <select class="form-select" id="AgeCategory" name="AgeCategory" required>
                                    <option value="">Select Age Range</option>
                                    <option value="18-24">18-24</option>
                                    <option value="25-29">25-29</option>
                                    <option value="30-34">30-34</option>
                                    <option value="35-39">35-39</option>
                                    <option value="40-44">40-44</option>
                                    <option value="45-49">45-49</option>
                                    <option value="50-54">50-54</option>
                                    <option value="55-59">55-59</option>
                                    <option value="60-64">60-64</option>
                                    <option value="65-69">65-69</option>
                                    <option value="70-74">70-74</option>
                                    <option value="75-79">75-79</option>
                                    <option value="80 or older">80 or older</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="Race" class="form-label">Race</label>
                                <select class="form-select" id="Race" name="Race" required>
                                    <option value="">Select Race</option>
                                    <option value="White">White</option>
                                    <option value="Black">Black</option>
                                    <option value="Hispanic">Hispanic</option>
                                    <option value="Asian">Asian</option>
                                    <option value="American Indian/Alaskan Native">American Indian/Alaskan Native</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Health Conditions -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-heartbeat me-2"></i>Health Conditions
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="PhysicalHealth" class="form-label">Physical Health (Days)</label>
                                <input type="number" class="form-control" id="PhysicalHealth" name="PhysicalHealth" 
                                       min="0" max="30" required>
                                <div class="form-text">Days in the past 30 days your physical health was not good (0-30)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="MentalHealth" class="form-label">Mental Health (Days)</label>
                                <input type="number" class="form-control" id="MentalHealth" name="MentalHealth" 
                                       min="0" max="30" required>
                                <div class="form-text">Days in the past 30 days your mental health was not good (0-30)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="SleepTime" class="form-label">Sleep Time (Hours)</label>
                                <input type="number" class="form-control" id="SleepTime" name="SleepTime" 
                                       min="0" max="24" step="0.5" required>
                                <div class="form-text">Hours of sleep per day (0-24)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="GenHealth" class="form-label">General Health</label>
                                <select class="form-select" id="GenHealth" name="GenHealth" required>
                                    <option value="">Select General Health</option>
                                    <option value="Excellent">Excellent</option>
                                    <option value="Very good">Very good</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lifestyle Factors -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-running me-2"></i>Lifestyle Factors
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="Smoking" class="form-label">Smoking</label>
                                <select class="form-select" id="Smoking" name="Smoking" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="AlcoholDrinking" class="form-label">Alcohol Drinking</label>
                                <select class="form-select" id="AlcoholDrinking" name="AlcoholDrinking" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="PhysicalActivity" class="form-label">Physical Activity</label>
                                <select class="form-select" id="PhysicalActivity" name="PhysicalActivity" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="DiffWalking" class="form-label">Difficulty Walking</label>
                                <select class="form-select" id="DiffWalking" name="DiffWalking" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Medical History -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-medical-bag me-2"></i>Medical History
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="Stroke" class="form-label">Previous Stroke</label>
                                <select class="form-select" id="Stroke" name="Stroke" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="Diabetic" class="form-label">Diabetes</label>
                                <select class="form-select" id="Diabetic" name="Diabetic" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="Asthma" class="form-label">Asthma</label>
                                <select class="form-select" id="Asthma" name="Asthma" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="KidneyDisease" class="form-label">Kidney Disease</label>
                                <select class="form-select" id="KidneyDisease" name="KidneyDisease" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="SkinCancer" class="form-label">Skin Cancer</label>
                                <select class="form-select" id="SkinCancer" name="SkinCancer" required>
                                    <option value="">Select</option>
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-calculator me-2"></i>Get Prediction
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section mt-5" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Prediction Results
                        </h4>
                    </div>
                    <div class="card-body">
                        <div id="predictionResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const resultsSection = document.getElementById('resultsSection');
    const resultsDiv = document.getElementById('predictionResults');
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
    submitBtn.disabled = true;
    
    try {
        // Get form data and convert to proper types
        const formData = new FormData(this);
        const data = {
            BMI: parseFloat(formData.get('BMI')) || 0,
            Smoking: formData.get('Smoking') === 'Yes' ? 'Yes' : 'No',
            AlcoholDrinking: formData.get('AlcoholDrinking') === 'Yes' ? 'Yes' : 'No',
            Stroke: formData.get('Stroke') === 'Yes' ? 'Yes' : 'No',
            PhysicalHealth: parseInt(formData.get('PhysicalHealth')) || 0,
            MentalHealth: parseInt(formData.get('MentalHealth')) || 0,
            DiffWalking: formData.get('DiffWalking') === 'Yes' ? 'Yes' : 'No',
            Sex: formData.get('Sex'),
            AgeCategory: formData.get('AgeCategory'),
            Race: formData.get('Race'),
            Diabetic: formData.get('Diabetic'),
            PhysicalActivity: formData.get('PhysicalActivity') === 'Yes' ? 'Yes' : 'No',
            GenHealth: formData.get('GenHealth'),
            SleepTime: parseFloat(formData.get('SleepTime')) || 0,
            Asthma: formData.get('Asthma') === 'Yes' ? 'Yes' : 'No',
            KidneyDisease: formData.get('KidneyDisease') === 'Yes' ? 'Yes' : 'No',
            SkinCancer: formData.get('SkinCancer') === 'Yes' ? 'Yes' : 'No'
        };
        
        // Log the data being sent
        console.log('Sending data to server:', data);
        
        // Send prediction request
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Display results
            displayResults(result);
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            throw new Error(result.error || 'Prediction failed');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    } finally {
        // Reset button
        submitBtn.innerHTML = '<i class="fas fa-calculator me-2"></i>Get Prediction';
        submitBtn.disabled = false;
    }
});

function displayResults(result) {
    const resultsDiv = document.getElementById('predictionResults');
    
    // Check if the result contains an error
    if (result.status === 'error') {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p>${result.error || 'An unknown error occurred'}</p>
                ${result.expected_features ? `<p>Expected ${result.expected_features} features, got ${result.received_features}</p>` : ''}
            </div>`;
        return;
    }
    
    // Convert probability to a number and ensure it's between 0 and 1
    const probability = parseFloat(result.probability);
    if (isNaN(probability) || probability < 0 || probability > 1) {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Warning</h5>
                <p>Received invalid probability value: ${result.probability}</p>
            </div>`;
        return;
    }
    
    const probabilityPercent = (probability * 100).toFixed(1);
    
    // Determine risk level and styling
    const isHighRisk = probability >= 0.5;
    const riskColor = isHighRisk ? 'danger' : 'success';
    const riskIcon = isHighRisk ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
    const riskText = isHighRisk ? 'High Risk' : 'Low Risk';
    
    resultsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="result-card">
                    <h5><i class="${riskIcon} me-2"></i>Risk Assessment</h5>
                    <div class="risk-indicator risk-${riskColor}">
                        <h3>${riskText}</h3>
                        <p>Risk Level: ${result.risk_level || 'Not specified'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="result-card">
                    <h5><i class="fas fa-percentage me-2"></i>Probability</h5>
                    <div class="probability-chart">
                        <div class="progress mb-2" style="height: 30px;">
                            <div class="progress-bar bg-${riskColor} progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: ${probabilityPercent}%"
                                 aria-valuenow="${probabilityPercent}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${probabilityPercent}%
                            </div>
                        </div>
                        <p class="mb-0 text-center">
                            <strong>Heart Disease Risk: ${probabilityPercent}%</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        ${result.recommendations && result.recommendations.length > 0 ? `
        <div class="recommendations mt-4">
            <h5><i class="fas fa-lightbulb me-2"></i>Recommendations</h5>
            <ul class="list-group">
                ${result.recommendations.map(rec => `<li class="list-group-item"><i class="fas fa-arrow-circle-right me-2"></i>${rec}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
    `;
}
</script>
{% endblock %}
